window.bridges["change-image-color"]=function(){var g={data:null,preview:null},c={data:null,preview:null},w={offsetX:0,offsetY:0,scale:1},b=[],M=!1,S=!1,P=function(){var a=this,e=q(a);if(!e)return;g.data||(g.data=a.input.element.querySelector(".data"),g.preview=a.input.element.querySelector(".preview"),c.data=a.output.element.querySelector(".data"),c.preview=a.output.element.querySelector(".preview"),Interactable.make(g.preview,{onclick:function(u,I){u=Math.round((u-w.offsetX)*w.scale),I=Math.round((I-w.offsetY)*w.scale);var p=H(g.data,u,I);a.options.set({color:p}),a.options.set({"old-color":p}),a.convert()}}),Interactable.disableScroll(g.preview));var r=a.input.element.querySelector(".side-box").classList.contains("empty");if(r||S)return;var n=a.trigger==Trigger.RESIZE,t=a.trigger==Trigger.EXAMPLE,o=a.trigger==Trigger.IMPORT;(t||o)&&(M=!1),g.preview.width!=g.preview.clientWidth&&(g.preview.width=g.preview.clientWidth,g.preview.height=g.preview.clientHeight,c.preview.width=c.preview.clientWidth,c.preview.height=c.preview.clientHeight);var d={width:g.data.width,height:g.data.height};if(n||t||o){var l=g.preview.getContext("2d");G(g.preview),w=best_image_fit(d.width,d.height,g.preview.width,g.preview.height),l.drawImage(g.data,w.offsetX,w.offsetY,w.width,w.height)}c.data.width=d.width,c.data.height=d.height;var i=c.data.getContext("2d");e.extension=="jpg"&&(i.fillStyle="white",i.fillRect(0,0,d.width,d.height)),i.drawImage(g.data,0,0);var v=i.getImageData(0,0,d.width,d.height),f=colorToRGBA(e.oldColor),h=colorToRGBA(e.newColor);e.extension=="jpg"&&(f=A(e.oldColor),h=A(e.newColor));var s={oldColorRGBA:f,newColorRGBA:h};if(E&&clearTimeout(E),e.changeColorTones&&M!==e.changeColorTones){S=!0,a.input.showWarningBadge("Image Is Being Processed","Hold tight! This might take a while.",-1),a.input.showStatus("processing...");var C=!0,E=setTimeout(m,100)}else{var C=!1;m()}function m(){if(C&&(M=!0,b=[],O(v)),e.changeColorTones)var u=N(v,b,s,e);else var u=X(v,s,e.threshold);if(e.smoothEdges){var I={radius:e.radius,lineWidth:d.width,newColor:h,changeColorTones:e.changeColorTones};$(v,u,I)}i.putImageData(v,0,0),a.respond();var p=c.preview.getContext("2d");G(c.preview);var T=best_image_fit(d.width,d.height,c.preview.width,c.preview.height);if(e.previewMask){var z=Y(u,d,e);p.drawImage(z,T.offsetX,T.offsetY,T.width,T.height)}else p.drawImage(c.data,T.offsetX,T.offsetY,T.width,T.height);C&&(S=!1,a.input.hideBadge())}};function A(a){var e=document.createElement("canvas"),r=e.getContext("2d");e.width=1,e.height=1,r.fillStyle="white",r.fillRect(0,0,1,1),r.fillStyle=a,r.fillRect(0,0,1,1);var n=r.getImageData(0,0,1,1).data;return{r:n[0],g:n[1],b:n[2],a:n[3]}}function H(a,e,r){var n=document.createElement("canvas"),t=n.getContext("2d");n.width=a.width,n.height=a.height,t.drawImage(g.data,0,0);var o=t.getImageData(e,r,1,1).data;return"rgba({0}, {1}, {2}, {3})".format(o[0],o[1],o[2],o[3])}function X(a,e,r){for(var n=e.oldColorRGBA,t=e.newColorRGBA,o={},d={},l=[],i=0;i<a.data.length;i+=4){var v={r:a.data[i+0],g:a.data[i+1],b:a.data[i+2],a:a.data[i+3]},f=v.r+","+v.g+","+v.b+","+v.a;if(o[f])a.data[i+0]=t.r,a.data[i+1]=t.g,a.data[i+2]=t.b,a.data[i+3]=t.a,l.push(i);else if(!d[f]){var h=rgbaDifference(v,n),s=h<=r;s?(a.data[i+0]=t.r,a.data[i+1]=t.g,a.data[i+2]=t.b,a.data[i+3]=t.a,o[f]=!0,l.push(i)):d[f]=!0}}return l}function N(a,e,r,n){for(var t=r.oldColorRGBA,o=r.newColorRGBA,d=n.threshold,l=y(o),i={},v={},f=[],h=0;h<a.data.length;h+=4){var s=e[h/4],C=s.rgba,E=s.hsl,m=C.r+","+C.g+","+C.b+","+C.a;if(i[m]){var u=i[m];a.data[h]=u[0],a.data[h+1]=u[1],a.data[h+2]=u[2],a.data[h+3]=o.a,f.push(h)}else if(!v[m]){var I=rgbaDifference(C,t);if(I<=d){var u=W(l[0],l[1],E[2]);a.data[h]=u[0],a.data[h+1]=u[1],a.data[h+2]=u[2],a.data[h+3]=o.a,i[m]=u,f.push(h)}else v[m]=!0}}return f}function y(a){var e=a.r/255,r=a.g/255,n=a.b/255,t=Math.min(e,r,n),o=Math.max(e,r,n),d=(o+t)/2,l=d,i=d,v=d;if(o==t)l=i=0;else{var f=o-t;i=v>.5?f/(2-o-t):f/(o+t),o==e?l=(r-n)/f+(r<n?6:0):o==r?l=(n-e)/f+2:o==n&&(l=(e-r)/f+4),l/=6}return[l,i,v]}function W(a,e,r){var n,t,o;if(e==0)n=t=o=r;else{var d=function(f,h,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?f+(h-f)*6*s:s<1/2?h:s<2/3?f+(h-f)*(2/3-s)*6:f},l=r<.5?r*(1+e):r+e-r*e,i=2*r-l;n=d(i,l,a+1/3),t=d(i,l,a),o=d(i,l,a-1/3)}return[Math.round(n*255),Math.round(t*255),Math.round(o*255)]}function O(a){for(var e=0;e<a.data.length;e+=4){var r={r:a.data[e],g:a.data[e+1],b:a.data[e+2],a:a.data[e+3]};b.push({rgba:r,hsl:y(r)})}}function Y(a,e,r){var n=document.createElement("canvas"),t=n.getContext("2d");n.width=e.width,n.height=e.height,t.fillStyle="white",t.fillRect(0,0,n.width,n.height);for(var o=t.getImageData(0,0,n.width,n.height),d={r:0,g:0,b:0,a:255},l={alphaDelta:0,colorCoef:1-1/(r.radius+1),lineWidth:e.width,newColor:d,radius:r.radius},i=0;i<a.length;i++)if(o.data[a[i]+0]=0,o.data[a[i]+1]=0,o.data[a[i]+2]=0,o.data[a[i]+3]=255,r.smoothEdges){var v=a[i]/4-r.radius-r.radius*l.lineWidth;B(o,v,l)}return t.putImageData(o,0,0),n}function $(a,e,r){for(var n={alphaDelta:parseInt(255/(r.radius+1)),colorCoef:1-1/(r.radius+1),lineWidth:r.lineWidth,newColor:r.newColor,radius:r.radius,changeColorTones:r.changeColorTones},t=0;t<e.length;t++){var o=e[t]/4-n.radius-n.radius*n.lineWidth;B(a,o,n)}}function B(a,e,r){for(var n=r.lineWidth,t=r.radius+1,o=Math.floor((e+t-1)/n)*n,d=n-t*2+1,l=1;l<t*2;l+=2){for(var i=e+t*l-l,v=i;v<i+l;v++)v>=o&&v<=o+n-1&&D(a,v*4,r);e+=d,o+=n}for(var l=0,v=t-2-l;v>=0;l++,v--){for(var f=e+(t+l)*(t*2)-(l+1),h=f-v;h<f+v+1;h++)h>=o&&h<=o+n-1&&D(a,h*4,r);e+=d,o+=n}}function D(a,e,r){if(r.newColor.a==0)a.data[e+3]=_(a.data[e+3]-r.alphaDelta);else{var n={r:a.data[e+0],g:a.data[e+1],b:a.data[e+2],a:a.data[e+3]};if(r.changeColorTones){var t=b[e/4];if(t)var o=t.hsl;else return;var d=y(r.newColor),l=W(d[0],d[1],o[2]),i={r:l[0],g:l[1],b:l[2],a:r.newColor.a}}else i=r.newColor;var v=F(n,i,r.colorCoef);a.data[e+0]=v.r,a.data[e+1]=v.g,a.data[e+2]=v.b,a.data[e+3]=v.a}}function F(a,e,r){var n=R(a.r,e.r,r),t=R(a.g,e.g,r),o=R(a.b,e.b,r),d=R(a.a,e.a,r);return{r:n,g:t,b:o,a:d}}function R(a,e,r){var n=a*r,t=e*(1-r);return n+t}function _(a){return a<0&&(a=0),a}function q(a){var e=a.options.get(),r=function(v,f){a.output.showNegativeBadge(v,f,-1)},n=e.extension||"png",t=e["old-color"]||e.color||e.from;if(t===void 0&&(t=""),t=t.trim(),/^[0-9a-f]+$/i.test(t)&&(t="#"+t),t.length==0)return r("Invalid Color to Change","Color name is not specified."),!1;if(!isColorValid(t))return r("Invalid Color to Change",'The color "{0}" is not a valid color.'.format(t)),!1;var o=e["new-color"]||e.to;if(o===void 0&&(o=""),o=o.trim(),/^[0-9a-f]+$/i.test(o)&&(o="#"+o),o.length==0)return r("Invalid New Color","New color not specified."),!1;if(!isColorValid(o))return r("Invalid New Color",'New color "{0}" is not a valid color.'.format(o)),!1;var d=e.threshold.replace(/\s*%\s*$/,"");if(!/^[+-]?\d*\.?\d+$/.test(d))return r("Invalid Threshold","Threshold contains non-digits."),!1;if(d=parseFloat(d),d<0)return r("Invalid Threshold","Threshold value cannot be negative."),!1;if(d>100)return r("Invalid Threshold","Threshold value must be less than or equal to 100."),!1;var l=e["smooth-edges"],i=1;if(l){if(i=e.radius.trim(),!/^[+-]?\d+$/.test(i))return r("Invalid Smooth Radius","Smooth radius contains non-digits."),!1;if(i=parseInt(i),i<1)return r("Invalid Smooth Radius","Smooth radius must be greater than zero."),!1}return{oldColor:t,newColor:o,threshold:d,previewMask:e.mask,radius:i,smoothEdges:l,extension:n,changeColorTones:e["change-color-tones"]}}function G(a){for(var e=a.getContext("2d"),r=a.width,n=a.height,t=15,o=!0,d=0;d<=r;d+=t)for(var l=0;l<=n;l+=t)o?e.fillStyle="#ffffff":e.fillStyle="#efefef",o=!o,e.fillRect(d,l,d+t,l+t)}function k(){return this.options.get().extension||"png"}return{converter:P,config:{type:"image",input:{import:"base64",noClipboard:!0,download:k,image:!0},output:{download:k,noClipboard:!0}}}};
